#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-push checks..."

# Store initial git status
INITIAL_STATUS=$(git status --porcelain)

# Check formatting
echo "ğŸ“ Checking code formatting..."
npm run format:check
FORMAT_EXIT_CODE=$?

if [ $FORMAT_EXIT_CODE -ne 0 ]; then
    echo "âŒ Code formatting issues found!"
    echo "ğŸ’¡ Run 'npm run format' to fix formatting issues"
    exit 1
fi

# Run linting
echo "ğŸ” Running linter..."
npm run lint
LINT_EXIT_CODE=$?

if [ $LINT_EXIT_CODE -ne 0 ]; then
    echo "âŒ Linting errors found!"
    echo "ğŸ’¡ Fix linting errors before pushing"
    exit 1
fi

# Run build
echo "ğŸ—ï¸  Running build..."
npm run build
BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -ne 0 ]; then
    echo "âŒ Build failed!"
    echo "ğŸ’¡ Fix build errors before pushing"
    exit 1
fi

# Check if any files were modified during the checks
FINAL_STATUS=$(git status --porcelain)

if [ "$INITIAL_STATUS" != "$FINAL_STATUS" ]; then
    echo "âš ï¸  WARNING: Files were modified during pre-push checks!"
    echo "ğŸ“‹ Modified files:"
    git status --porcelain
    echo ""
    echo "ğŸš¨ PUSH BLOCKED: Please review and commit these changes first"
    echo "ğŸ’¡ The automated checks may have fixed some issues"
    exit 1
fi

echo "âœ… All pre-push checks passed!"